{% extends 'core/base.html' %}

{% block content %}
<h1>Dashboard de Auditoría</h1>

<div class="row">
  <div class="col-md-6">
    <div class="card p-3 mb-4">
      <h5>Eventos por Entidad</h5>
      <canvas id="entityChart"
              data-entities='{{ entity_data|safe }}'></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3 mb-4">
      <h5>Eventos por Acción</h5>
      <canvas id="actionChart"
              data-actions='{{ action_data|safe }}'></canvas>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Evolución de Eventos por Día</h5>
      <canvas id="timelineChart"
              data-timeline='{{ timeline_data|safe }}'></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Entidades ---
  const entityCtx = document.getElementById("entityChart");
  const entityData = JSON.parse(entityCtx.dataset.entities);
  new Chart(entityCtx, {
    type: 'bar',
    data: {
      labels: entityData.map(e => e.entity),
      datasets: [{
        label: 'Eventos',
        data: entityData.map(e => e.total),
        backgroundColor: '#4F81BD'
      }]
    }
  });

  // --- Acciones ---
  const actionCtx = document.getElementById("actionChart");
  const actionData = JSON.parse(actionCtx.dataset.actions);
  new Chart(actionCtx, {
    type: 'pie',
    data: {
      labels: actionData.map(a => a.action),
      datasets: [{
        data: actionData.map(a => a.total),
        backgroundColor: ['#4F81BD','#C0504D','#9BBB59','#8064A2','#F79646','#2C4D75']
      }]
    }
  });

  // --- Línea de tiempo ---
  const timelineCtx = document.getElementById("timelineChart");
  const timelineData = JSON.parse(timelineCtx.dataset.timeline);
  new Chart(timelineCtx, {
    type: 'line',
    data: {
      labels: timelineData.map(t => t.day),
      datasets: [{
        label: 'Eventos por día',
        data: timelineData.map(t => t.total),
        borderColor: '#4F81BD',
        fill: false,
        tension: 0.1
      }]
    }
  });
});
</script>
{% endblock %}
