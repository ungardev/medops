<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Orden de Cobro #{{ charge_order.id }}</title>
  <style>
    @page { size: A4; margin: 1.5cm; }
    body { font-family: "DejaVu Sans", Arial, sans-serif; font-size: 11px; line-height: 1.4; margin: 0; padding: 0; color: #1a1a1a; }
    header { text-align: center; border-bottom: 2px solid #1a1a1a; padding-bottom: 12px; margin-bottom: 16px; }
    .logo { max-width: 100px; max-height: 60px; margin-bottom: 8px; }
    .institution-name { font-size: 18px; font-weight: 700; margin: 0 0 4px 0; }
    .institution-meta { font-size: 10px; color: #555; margin: 2px 0; }
    .order-badge { background: #1a1a1a; color: #fff; padding: 6px 16px; font-size: 12px; font-weight: 700; margin-top: 10px; display: inline-block; }
    .order-status { font-size: 10px; color: #666; margin-top: 4px; }
    .section { margin-bottom: 14px; }
    .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin: 0 0 8px 0; }
    .info-grid { width: 100%; }
    .info-grid td { width: 50%; vertical-align: top; padding-right: 12px; }
    .info-label { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #666; }
    .info-value { font-size: 12px; font-weight: 500; margin-bottom: 2px; }
    table { width: 100%; border-collapse: collapse; font-size: 10px; }
    th { background: #f5f5f5; font-weight: 700; text-transform: uppercase; font-size: 9px; padding: 8px 6px; text-align: left; border-bottom: 2px solid #1a1a1a; }
    td { padding: 7px 6px; border-bottom: 1px solid #e5e5e5; }
    td.num { text-align: right; font-family: monospace; }
    .financial-box { background: #fafafa; border: 1px solid #e5e5e5; padding: 12px; }
    .financial-row { width: 100%; }
    .financial-row td { border: none; padding: 4px 0; }
    .financial-row.total td { border-top: 2px solid #1a1a1a; font-weight: 700; font-size: 13px; padding-top: 8px; }
    .financial-row.paid td:last-child { color: #2d7a3d; }
    .financial-row.pending td:last-child { color: #c44; }
    .doctor-block { width: 100%; }
    .doctor-block td { border: none; }
    .doctor-name { font-size: 13px; font-weight: 700; }
    .doctor-meta { font-size: 10px; color: #555; }
    .doctor-signature { max-height: 40px; }
    footer { margin-top: 20px; padding-top: 12px; border-top: 2px solid #1a1a1a; text-align: center; }
    .footer-main { font-size: 10px; color: #333; margin-bottom: 8px; }
    .qr-container { text-align: center; }
    .qr-container img { height: 70px; }
    .audit-label { font-size: 8px; color: #888; margin-top: 4px; }
    .audit-code { font-family: monospace; font-size: 9px; font-weight: 700; color: #555; background: #f5f5f5; padding: 2px 8px; }
    .empty { color: #999; font-style: italic; text-align: center; padding: 16px; }
  </style>
</head>
<body>
  <header>
    {% if institution_logo_path %}
      <img src="{{ institution_logo_path }}" alt="Logo" class="logo">
    {% endif %}
    <h1 class="institution-name">{{ institution.name|upper|default:"INSTITUCIÓN" }}</h1>
    <p class="institution-meta">
      {% if institution.address %}{{ institution.address }}{% endif %}
      {% if institution.phone %} | Tel: {{ institution.phone }}{% endif %}
      {% if institution.tax_id %} | RIF: {{ institution.tax_id }}{% endif %}
    </p>
    <div class="order-badge">ORDEN DE COBRO #{{ charge_order.id }}</div>
    <p class="order-status">Estado: <strong>{{ status_label }}</strong> | Emitido: {{ generated_at|date:"d/m/Y H:i" }}</p>
  </header>
  <div class="section">
    <table class="info-grid">
      <tr>
        <td>
          <p class="info-label">Paciente</p>
          <p class="info-value">{{ patient.first_name|default:"" }} {{ patient.last_name|default:"" }}</p>
          <p style="font-size: 10px; color: #555;">
            {% if patient.national_id %}C.I.: {{ patient.national_id }}{% endif %}
            {% if patient.age %} | Edad: {{ patient.age }} años{% endif %}
          </p>
        </td>
        <td>
          <p class="info-label">Consulta</p>
          {% if appointment %}
            <p class="info-value">#{{ appointment.id }}</p>
            <p style="font-size: 10px; color: #555;">Fecha: {{ appointment.appointment_date|date:"d/m/Y" }}</p>
          {% else %}
            <p class="info-value">Sin consulta</p>
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
  <div class="section">
    <h2 class="section-title">Detalle de Servicios</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 15%;">Código</th>
          <th style="width: 45%;">Descripción</th>
          <th style="width: 10%;">Cant.</th>
          <th style="width: 15%;">P. Unit.</th>
          <th style="width: 15%;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.code|default:"-" }}</td>
          <td>{{ item.description }}</td>
          <td class="num">{{ item.qty }}</td>
          <td class="num">${{ item.unit_price }}</td>
          <td class="num">${{ item.subtotal }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="empty">Sin servicios registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="section">
    <h2 class="section-title">Resumen Financiero</h2>
    <div class="financial-box">
      <table class="financial-row">
        <tr><td>Subtotal</td><td class="num">${{ subtotal }}</td></tr>
      </table>
      <table class="financial-row total">
        <tr><td>TOTAL</td><td class="num">${{ total }}</td></tr>
      </table>
      <table class="financial-row paid">
        <tr><td>Pagado</td><td class="num">${{ paid_amount }}</td></tr>
      </table>
      <table class="financial-row pending">
        <tr><td>Pendiente</td><td class="num">${{ balance_due }}</td></tr>
      </table>
    </div>
  </div>
  <div class="section">
    <h2 class="section-title">Pagos Registrados</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 20%;">Fecha</th>
          <th style="width: 25%;">Método</th>
          <th style="width: 25%;">Referencia</th>
          <th style="width: 15%;">Monto</th>
          <th style="width: 15%;">Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for pay in payments %}
        <tr>
          <td>{{ pay.received_at|date:"d/m/Y H:i" }}</td>
          <td>{{ pay.method }}</td>
          <td>{{ pay.reference }}</td>
          <td class="num">${{ pay.amount }}</td>
          <td>{{ pay.status }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="empty">Sin pagos registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="section">
    <h2 class="section-title">Médico Responsable</h2>
    <table class="doctor-block">
      <tr>
        <td>
          <p class="doctor-name">{{ doctor_name }}</p>
          <p class="doctor-meta">
            {% if doctor_colegiado %}Nº Colegiado: {{ doctor_colegiado }}{% endif %}
            {% if doctor_specialties %}<br>Especialidades: {{ doctor_specialties|join:", " }}{% endif %}
          </p>
        </td>
        <td style="text-align: right;">
          {% if doctor_signature_path %}
            <img src="{{ doctor_signature_path }}" alt="Firma" class="doctor-signature">
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
  <footer>
    <p class="footer-main">
      Este documento forma parte del expediente clínico institucional.<br>
      Emitido por {{ doctor_name }} | {{ institution.name|default:"Institución" }}
    </p>
    <div class="qr-container">
      <img src="{{ qr_code_url }}" alt="QR">
      <p class="audit-label">CÓDIGO DE VERIFICACIÓN</p>
      <span class="audit-code">{{ audit_code }}</span>
    </div>
  </footer>
</body>
</html>