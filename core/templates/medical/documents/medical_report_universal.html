<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Informe Médico Completo - {{ institution.name }}</title>
  <style>
    @page {
      size: A4;
      margin: 1.5cm;
    }
    body {
      font-family: "DejaVu Sans", sans-serif;
      font-size: 12px;
      line-height: 1.4;
      margin: 0;
      padding: 0;
      color: #000;
    }
    header {
      text-align: center;
      border-bottom: 1px solid #000;
      margin-bottom: 12px;
      padding-bottom: 6px;
    }
    h1 { font-size: 16px; margin: 0; color: #000; }
    h2 { font-size: 13px; margin: 10px 0 6px 0; border-bottom: 1px solid #ccc; color: #000; }
    h3 { font-size: 12px; margin: 6px 0 4px 0; color: #374151; }
    .section { margin-bottom: 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }
    th, td { 
      border: 1px solid #000; 
      padding: 4px; 
      text-align: left; 
      vertical-align: top; 
    }
    th { background: #f0f0f0; color: #000; font-weight: 600; }
    .label { font-weight: 600; color: #374151; }
    .empty { color: #666; font-style: italic; }
    .soap-section { 
      margin-bottom: 10px; 
      padding: 8px; 
      background: #fafafa; 
      border-left: 3px solid #000; 
    }
    .soap-header { 
      font-weight: 600; 
      font-size: 11px; 
      text-transform: uppercase; 
      margin-bottom: 4px; 
      color: #374151;
    }
    .vitals-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .vital-item {
      flex: 1;
      min-width: 100px;
      padding: 6px;
      background: #f5f5f5;
      border: 1px solid #ddd;
    }
    .vital-label { font-size: 9px; color: #666; text-transform: uppercase; }
    .vital-value { font-size: 14px; font-weight: 600; }
    footer {
      margin-top: 12px;
      font-size: 10px;
      text-align: center;
      border-top: 1px solid #000;
      padding-top: 6px;
    }
    .qr { margin-top: 8px; }
    .signature-area {
      margin-top: 20px;
      border-top: 1px dashed #ccc;
      padding-top: 15px;
    }
    .section, table, .soap-section { page-break-inside: avoid; }
  </style>
</head>
<body>
  <!-- HEADER INSTITUCIONAL -->
  <header>
    {% if institution.logo %}
      <img src="{{ institution.logo.path }}" alt="Logo Institucional"
           style="max-width:120px; max-height:70px; object-fit:contain; margin-bottom:6px;">
    {% endif %}
    <h1>{{ institution.name }}</h1>
    <p>{{ institution.address }} - Tel: {{ institution.phone }} - RIF: {{ institution.tax_id }}</p>
    <p>Emitido el {{ generated_at|date:"d/m/Y H:i" }}</p>
    <p><strong>Consulta #{{ appointment.id }} — Código de auditoría: {{ audit_code }}</strong></p>
  </header>
  <!-- SECCIÓN DE PACIENTE -->
  <div class="section">
    <strong>Paciente:</strong> {{ patient.full_name }}<br>
    C.I.: {{ patient.national_id }} - Edad: {{ patient.age }} años - Sexo: {{ patient.gender }}<br>
    {% if patient.phone %}Teléfono: {{ patient.phone }} - {% endif %}
    {% if patient.email %}Email: {{ patient.email }}{% endif %}
  </div>
  <!-- SECCIÓN DEL MÉDICO -->
  <div class="section">
    <strong>Médico Tratante:</strong> {{ doctor.full_name }}<br>
    {% if doctor.colegiado_id %}Nº Colegiado: {{ doctor.colegiado_id }}<br>{% endif %}
    {% if doctor_specialties %}Especialidades: {{ doctor_specialties|join:", " }}{% endif %}
    {% if doctor.signature %}
    <div style="margin-top:6px;">
      <img src="{{ doctor.signature.path }}" alt="Firma" style="height:40px;">
    </div>
    {% endif %}
  </div>
  <!-- SIGNOS VITALES (Solo si hay datos) -->
  {% if vital_signs %}
  <div class="section">
    <h2>Signos Vitales</h2>
    <div class="vitals-grid">
      {% if vital_signs.weight %}
      <div class="vital-item">
        <div class="vital-label">Peso</div>
        <div class="vital-value">{{ vital_signs.weight }} kg</div>
      </div>
      {% endif %}
      {% if vital_signs.height %}
      <div class="vital-item">
        <div class="vital-label">Talla</div>
        <div class="vital-value">{{ vital_signs.height }} cm</div>
      </div>
      {% endif %}
      {% if vital_signs.bmi %}
      <div class="vital-item">
        <div class="vital-label">IMC</div>
        <div class="vital-value">{{ vital_signs.bmi|floatformat:1 }}</div>
      </div>
      {% endif %}
      {% if vital_signs.bp_systolic and vital_signs.bp_diastolic %}
      <div class="vital-item">
        <div class="vital-label">Presión Arterial</div>
        <div class="vital-value">{{ vital_signs.bp_systolic }}/{{ vital_signs.bp_diastolic }} mmHg</div>
      </div>
      {% endif %}
      {% if vital_signs.temperature %}
      <div class="vital-item">
        <div class="vital-label">Temperatura</div>
        <div class="vital-value">{{ vital_signs.temperature }} °C</div>
      </div>
      {% endif %}
      {% if vital_signs.heart_rate %}
      <div class="vital-item">
        <div class="vital-label">Frecuencia Cardíaca</div>
        <div class="vital-value">{{ vital_signs.heart_rate }} lpm</div>
      </div>
      {% endif %}
      {% if vital_signs.respiratory_rate %}
      <div class="vital-item">
        <div class="vital-label">Frecuencia Respiratoria</div>
        <div class="vital-value">{{ vital_signs.respiratory_rate }} rpm</div>
      </div>
      {% endif %}
      {% if vital_signs.oxygen_saturation %}
      <div class="vital-item">
        <div class="vital-label">Saturación O₂</div>
        <div class="vital-value">{{ vital_signs.oxygen_saturation }}%</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  <!-- NOTA CLÍNICA (Estructura SOAP) -->
  {% if clinical_note %}
  <div class="section">
    <h2>Nota Clínica</h2>
    
    {% if clinical_note.subjective %}
    <div class="soap-section">
      <div class="soap-header">Subjetivo</div>
      <p>{{ clinical_note.subjective }}</p>
    </div>
    {% endif %}
    
    {% if clinical_note.objective %}
    <div class="soap-section">
      <div class="soap-header">Objetivo</div>
      <p>{{ clinical_note.objective }}</p>
    </div>
    {% endif %}
    
    {% if clinical_note.analysis %}
    <div class="soap-section">
      <div class="soap-header">Análisis</div>
      <p>{{ clinical_note.analysis }}</p>
    </div>
    {% endif %}
    
    {% if clinical_note.plan %}
    <div class="soap-section">
      <div class="soap-header">Plan</div>
      <p>{{ clinical_note.plan }}</p>
    </div>
    {% endif %}
  </div>
  {% endif %}
  <!-- DIAGNÓSTICOS -->
  <div class="section">
    <h2>Diagnósticos</h2>
    {% if diagnoses %}
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Diagnóstico</th>
          <th>Tipo</th>
          <th>Descripción</th>
        </tr>
      </thead>
      <tbody>
        {% for d in diagnoses %}
        <tr>
          <td>{{ d.icd_code }}</td>
          <td>{{ d.title }}</td>
          <td>{{ d.get_type_display|default:"Diagnóstico" }}</td>
          <td>{{ d.description|default:"Sin descripción" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="empty">Sin diagnósticos registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty">No hay diagnósticos registrados</p>
    {% endif %}
  </div>
  <!-- TRATAMIENTOS -->
  <div class="section">
    <h2>Tratamientos</h2>
    {% if treatments %}
    <table>
      <thead>
        <tr>
          <th>Tratamiento</th>
          <th>Tipo</th>
          <th>Duración</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for t in treatments %}
        <tr>
          <td>{{ t.plan }}</td>
          <td>{{ t.get_treatment_type_display|default:t.treatment_type|default:"General" }}</td>
          <td>
            {% if t.start_date and t.end_date %}
              {{ t.start_date|date:"d/m/Y" }} - {{ t.end_date|date:"d/m/Y" }}
            {% elif t.start_date %}
              Desde {{ t.start_date|date:"d/m/Y" }}
            {% else %}
              No especificada
            {% endif %}
          </td>
          <td>{{ t.get_status_display|default:t.status|default:"Activo" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="empty">Sin tratamientos registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty">No hay tratamientos registrados</p>
    {% endif %}
  </div>
  <!-- PRESCRIPCIONES -->
  <div class="section">
    <h2>Prescripciones</h2>
    {% if prescriptions %}
    <table>
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Composición</th>
          <th>Vía</th>
          <th>Frecuencia</th>
          <th>Duración</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prescriptions %}
        <tr>
          <td>
            {% if p.medication_catalog %}
              {{ p.medication_catalog.name }}
            {% elif p.medication_text %}
              {{ p.medication_text }}
            {% else %}
              <span class="empty">Sin nombre</span>
            {% endif %}
          </td>
          <td>
            {% if p.components.all %}
              {% for c in p.components.all %}{{ c.substance }} {{ c.dosage }}{{ c.unit }}{% if not forloop.last %}, {% endif %}{% endfor %}
            {% else %}
              <span class="empty">Sin componentes</span>
            {% endif %}
          </td>
          <td>{{ p.get_route_display|default:p.route|default:"N/A" }}</td>
          <td>{{ p.get_frequency_display|default:p.frequency|default:"N/A" }}</td>
          <td>{{ p.duration|default:"N/A" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="empty">Sin prescripciones registradas</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty">No hay prescripciones registradas</p>
    {% endif %}
  </div>
  <!-- ÓRDENES DE EXÁMENES -->
  <div class="section">
    <h2>Órdenes de Exámenes</h2>
    {% if medical_tests %}
    <table>
      <thead>
        <tr>
          <th>Examen</th>
          <th>Tipo</th>
          <th>Urgencia</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for test in medical_tests %}
        <tr>
          <td>
            {% if test.test_name_override %}
              {{ test.test_name_override }}
            {% else %}
              {{ test.get_test_type_display|default:test.test_type|default:"Examen" }}
            {% endif %}
          </td>
          <td>{{ test.get_test_type_display|default:test.test_type|default:"General" }}</td>
          <td>{{ test.get_urgency_display|default:test.urgency|default:"Rutina" }}</td>
          <td>{{ test.get_status_display|default:test.status|default:"Pendiente" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="empty">Sin exámenes ordenados</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty">No hay órdenes de exámenes registradas</p>
    {% endif %}
  </div>
  <!-- REFERENCIAS MÉDICAS -->
  <div class="section">
    <h2>Referencias Médicas</h2>
    {% if referrals %}
    <table>
      <thead>
        <tr>
          <th>Destino</th>
          <th>Especialidad</th>
          <th>Motivo</th>
          <th>Urgencia</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for r in referrals %}
        <tr>
          <td>
            {% if r.referred_to_doctor %}
              {{ r.referred_to_doctor.full_name }}
            {% elif r.referred_to_external %}
              {{ r.referred_to_external }}
            {% else %}
              <span class="empty">Por asignar</span>
            {% endif %}
          </td>
          <td>
            {% for s in r.specialties.all %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% empty %}<span class="empty">No especificada</span>{% endfor %}
          </td>
          <td>{{ r.reason|default:"Sin motivo" }}</td>
          <td>{{ r.get_urgency_display|default:r.urgency|default:"Rutina" }}</td>
          <td>{{ r.get_status_display|default:r.status|default:"Emitida" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="empty">Sin referencias registradas</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty">No hay referencias médicas registradas</p>
    {% endif %}
  </div>
  <!-- ÁREA DE FIRMA -->
  <div class="signature-area">
    <h3>Firma del Médico Tratante</h3>
    <table>
      <tr>
        <td width="50%">
          <strong>{{ doctor.full_name }}</strong><br>
          Nº Colegiado: {{ doctor.colegiado_id|default:"N/A" }}<br>
          {% if doctor_specialties %}
          Especialidades: {{ doctor_specialties|join:", " }}<br>
          {% endif %}
          {% if doctor.signature %}
          <div style="margin-top:10px;">
            <img src="{{ doctor.signature.path }}" alt="Firma" style="height:45px;">
          </div>
          {% endif %}
        </td>
        <td width="50%">
          <table style="border: none; width: 100%;">
            <tr>
              <td><span class="label">Firma:</span></td>
              <td>_________________________</td>
            </tr>
            <tr>
              <td><span class="label">Fecha:</span></td>
              <td>{{ generated_at|date:"d/m/Y" }}</td>
            </tr>
            <tr>
              <td><span class="label">Sello:</span></td>
              <td>_________________________</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>
  <!-- FOOTER -->
  <footer>
    Este informe médico forma parte del expediente clínico institucional.<br>
    Generado por {{ doctor.full_name }} - {{ institution.name }}<br>
    Código de auditoría: {{ audit_code }}
    <div class="qr">
      <img src="{{ qr_code_url }}" alt="QR Auditoría" style="height:80px;">
    </div>
  </footer>
</body>
</html>