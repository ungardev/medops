<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Documento de Prescripciones</title>
  <style>
    @page { size: A4 landscape; margin: 1.5cm; }
    body { font-family: "DejaVu Sans", sans-serif; font-size: 12px; line-height: 1.3; margin:0; padding:0; }
    header { text-align: center; border-bottom: 1px solid #000; margin-bottom: 12px; padding-bottom: 6px; }
    h1 { font-size: 16px; margin: 0; }
    h2 { font-size: 13px; margin: 8px 0 6px 0; border-bottom: 1px solid #ccc; }
    .section { margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 11px; }
    th, td { border: 1px solid #000; padding: 4px; text-align: left; }
    th { background: #f0f0f0; }
    td.num { text-align: right; }
    .empty { color:#666; font-style:italic; }
    footer { margin-top: 12px; font-size: 10px; text-align: center; border-top: 1px solid #000; padding-top: 6px; }
    .qr { margin-top: 8px; }
    .meta-small { font-size: 11px; }
    .prescription-item { page-break-inside: avoid; margin-bottom: 15px; }
    .prescription-item:last-child { page-break-inside: avoid; }
    .med-name { font-weight: bold; color: #000; }
    .diagnosis-ref { font-size: 10px; color: #666; margin-bottom: 4px; }
    .components-table { margin-top: 4px; }
    .indications { margin-top: 4px; font-style: italic; font-size: 10px; }
  </style>
</head>
<body>
  <header>
    {% if institution and institution.logo %}
      <img src="{{ institution.logo.path }}" alt="Logo institucional"
           style="max-width:140px; max-height:80px; object-fit:contain; margin-bottom:6px;">
    {% endif %}
    <h1>Documento de Prescripciones Médicas</h1>
    <p>{{ institution.name|default:"Centro clínico" }}</p>
    {% if institution.address or institution.phone or institution.tax_id %}
      <p>
        {% if institution.address %}{{ institution.address }}{% endif %}
        {% if institution.phone %} - Tel: {{ institution.phone }}{% endif %}
        {% if institution.tax_id %} - RIF: {{ institution.tax_id }}{% endif %}
      </p>
    {% endif %}
    <p>Emitido el {{ generated_at|date:"d/m/Y H:i" }}</p>
    <p><strong>Consulta #{{ appointment.id }} — Código de auditoría: {{ audit_code }}</strong></p>
  </header>
  <div class="section">
    <strong>Paciente:</strong> {{ patient.full_name }}<br>
    C.I.: {{ patient.national_id }} — Sexo: {{ patient.gender }} — Edad: {{ patient.age }}
  </div>
  <div class="section">
    <strong>Médico:</strong> {{ doctor.full_name }}
    {% if doctor.colegiado_id %} — Nº Colegiado: {{ doctor.colegiado_id }}{% endif %}
    <div class="meta-small">
      {% if doctor.specialties %}<strong>Especialidades:</strong> {{ doctor.specialties|join:", " }}{% endif %}
    </div>
    {% if doctor.signature %}
      <div style="margin-top:6px;">
        <img src="{{ doctor.signature.path }}" alt="Firma" style="height:45px;">
      </div>
    {% endif %}
  </div>
  <div class="section">
    <h2>Prescripciones Médicas ({{ items|length }})</h2>
    {% if items %}
      {% for p in items %}
      <div class="prescription-item">
        <div class="diagnosis-ref">
          {% if p.diagnosis_code %}Código: {{ p.diagnosis_code }}{% endif %}
          {% if p.diagnosis_title %} - {{ p.diagnosis_title }}{% endif %}
        </div>
        
        <table>
          <thead>
            <tr>
              <th style="width: 30%;">Medicamento</th>
              <th style="width: 20%;">Vía</th>
              <th style="width: 20%;">Frecuencia</th>
              <th style="width: 15%;">Duración</th>
              <th style="width: 15%;">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="med-name">{{ p.medication }}</td>
              <td>{{ p.route }}</td>
              <td>{{ p.frequency }}</td>
              <td>{{ p.duration }}</td>
              <td>{% if p.is_controlled %}<strong>CONTROLADO</strong>{% else %}Normal{% endif %}</td>
            </tr>
          </tbody>
        </table>
        {% if p.components %}
        <table class="components-table">
          <thead>
            <tr>
              <th style="width: 40%;">Principio Activo</th>
              <th style="width: 30%;">Concentración</th>
              <th style="width: 30%;">Unidad</th>
            </tr>
          </thead>
          <tbody>
            {% for c in p.components %}
            <tr>
              <td>{{ c.substance }}</td>
              <td>{{ c.dosage }}</td>
              <td>{{ c.unit }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
        {% if p.notes %}
        <div class="indications">
          <strong>Indicaciones:</strong> {{ p.notes }}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <p class="empty">Sin prescripciones</p>
    {% endif %}
  </div>
  <footer>
    Documento generado automáticamente por MedOps<br>
    {{ institution.name }}
    <div class="qr">
      <img src="{{ qr_code_url }}" alt="QR Auditoría" style="height:80px;">
    </div>
  </footer>
</body>
</html>