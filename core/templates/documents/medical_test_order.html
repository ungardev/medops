<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Orden de Examen Médico</title>
  <style>
    @page { size: A4; margin: 1.5cm; }
    body { font-family: "DejaVu Sans", sans-serif; font-size: 12px; line-height: 1.3; margin:0; padding:0; }
    header { text-align: center; border-bottom: 1px solid #000; margin-bottom: 12px; padding-bottom: 6px; }
    h1 { font-size: 16px; margin: 0; }
    h2 { font-size: 13px; margin: 8px 0 6px 0; border-bottom: 1px solid #ccc; }
    h3 { font-size: 12px; margin: 6px 0; }
    .section { margin-bottom: 12px; }
    .recipera { display: flex; flex-direction: row; justify-content: space-between; gap: 12px; }
    .column { width: 48%; page-break-inside: avoid; }
    .table-compact { width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 11px; }
    .table-compact th, .table-compact td { border: 1px solid #000; padding: 4px; text-align: left; }
    .table-compact th { background: #f0f0f0; }
    .empty { color:#666; font-style:italic; }
    footer { margin-top: 12px; font-size: 10px; text-align: center; border-top: 1px solid #000; padding-top: 6px; }
    .qr { margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    {% if institution.logo %}
      <img src="{{ institution.logo.path }}" alt="Logo institucional"
           style="max-width:120px; max-height:70px; object-fit:contain; margin-bottom:6px;">
    {% endif %}
    <h1>Orden de Examen Médico</h1>
    <p>{{ institution.name }}</p>
    <p>Emitido el {{ generated_at|date:"d/m/Y H:i" }}</p>
    <p><strong>Consulta #{{ appointment.id }} — Código de auditoría: {{ audit_code }}</strong></p>
  </header>

  <div class="section">
    <strong>Paciente:</strong> {{ patient.full_name }}<br>
    C.I.: {{ patient.national_id }} — Sexo: {{ patient.gender }} — Edad: {{ patient.age }}
  </div>

  <div class="section">
    <strong>Médico:</strong> {{ doctor.full_name }}
    {% if doctor.colegiado_id %} — Nº Colegiado: {{ doctor.colegiado_id }}{% endif %}
  </div>

  <div class="section">
    <h2>Órdenes de Exámenes Médicos</h2>
    {% if appointment.medical_tests.all %}
      <div class="recipera">
        <!-- Columna izquierda: Laboratorios -->
        <div class="column">
          <h3>Laboratorios</h3>
          <table class="table-compact">
            <thead>
              <tr><th>Tipo</th><th>Descripción</th><th>Urgencia</th><th>Estado</th></tr>
            </thead>
            <tbody>
              {% for t in appointment.medical_tests.all %}
                {% if t.test_type in "blood_test,urine_test,stool_test,microbiology_culture,biopsy,genetic_test" %}
                <tr>
                  <td>{{ t.get_test_type_display }}</td>
                  <td>{{ t.description|default:"Sin descripción" }}</td>
                  <td>{{ t.get_urgency_display }}</td>
                  <td>{{ t.get_status_display }}</td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Columna derecha: Imágenes/Estudios -->
        <div class="column">
          <h3>Imágenes / Estudios</h3>
          <table class="table-compact">
            <thead>
              <tr><th>Tipo</th><th>Descripción</th><th>Urgencia</th><th>Estado</th></tr>
            </thead>
            <tbody>
              {% for t in appointment.medical_tests.all %}
                {% if t.test_type in "xray,ultrasound,ct_scan,mri,ecg" %}
                <tr>
                  <td>{{ t.get_test_type_display }}</td>
                  <td>{{ t.description|default:"Sin descripción" }}</td>
                  <td>{{ t.get_urgency_display }}</td>
                  <td>{{ t.get_status_display }}</td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <p class="empty">No hay órdenes de exámenes en esta consulta.</p>
    {% endif %}
  </div>

  <footer>
    Documento generado automáticamente por MedOps<br>
    {{ institution.name }}
    <div class="qr">
      <img src="{{ qr_code_url }}" alt="QR Auditoría" style="height:80px;">
    </div>
  </footer>
</body>
</html>
