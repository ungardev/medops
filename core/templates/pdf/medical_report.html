<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <style>
    @page {
      size: A4;              /* o "letter" según tu preferencia */
      margin: 1.5cm;         /* márgenes un poco más amplios */
    }
    body {
      font-family: "DejaVu Sans", sans-serif;
      font-size: 12px;       /* fuente más grande */
      line-height: 1.3;      /* espaciado más cómodo */
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      border-bottom: 1px solid #000;
      margin-bottom: 12px;
      padding-bottom: 6px;
    }
    h1 {
      font-size: 16px;
      margin: 0;
    }
    h2 {
      font-size: 13px;
      margin: 8px 0 6px 0;
      border-bottom: 1px solid #ccc;
    }
    .section {
      margin-bottom: 12px;   /* más espacio entre secciones */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;       /* tablas un poco más grandes */
    }
    th, td {
      border: 1px solid #000;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    td.num {
      text-align: right;
    }
    ul {
      margin: 3px 0;
      padding-left: 18px;
    }
    .empty {
      color: #666;
      font-style: italic;
    }
    footer {
      margin-top: 12px;
      font-size: 10px;       /* footer más legible */
      text-align: center;
      border-top: 1px solid #000;
      padding-top: 6px;
    }
    .qr {
      margin-top: 8px;
    }
    /* Evitar saltos de página innecesarios */
    .section, table, ul, p {
      page-break-inside: avoid;
    }
  </style>
</head>
<body>
  <header>
    {% if institution.logo %}
      <img src="{{ institution.logo.path }}" alt="Logo"
           style="max-width:120px; max-height:70px; object-fit:contain; margin-bottom:6px;">
    {% endif %}
    <h1>{{ institution.name }}</h1>
    <p>{{ institution.address }} - Tel: {{ institution.phone }} - RIF: {{ institution.tax_id }}</p>
    <p>Emitido el {{ generated_at|date:"d/m/Y H:i" }}</p>
    <p><strong>Consulta #{{ appointment.id }} — Código de auditoría: {{ report.id }}</strong></p>
  </header>

  <div class="section">
    <strong>Paciente:</strong> {{ patient.first_name }} {{ patient.last_name }}<br>
    C.I.: {{ patient.national_id }} - Edad: {{ patient.age }} - Sexo: {{ patient.gender }}
  </div>

  <div class="section">
    <strong>Médico:</strong> {{ doctor.full_name }}<br>
    Nº Colegiado: {{ doctor.colegiado_id }}<br>
    <p style="margin:0;"><strong>Especialidades:</strong>
      {% if doctor.specialties %}
        {{ doctor.specialties|join:", " }}
      {% else %}
        No especificadas
      {% endif %}
    </p>
    {% if doctor.signature %}
      <div style="margin-top:6px;">
        <img src="{{ doctor.signature.path }}" alt="Firma" style="height:45px;">
      </div>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnósticos</h2>
    <table>
      <thead>
        <tr><th>Código</th><th>Nombre</th><th>Descripción</th></tr>
      </thead>
      <tbody>
        {% for d in diagnoses %}
        <tr>
          <td>{{ d.icd_code }}</td>
          <td>{{ d.title }}</td>
          <td>{{ d.description }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">Sin diagnósticos</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Tratamientos</h2>
    <ul>
      {% for t in treatments %}
      <li>{{ t.plan }}</li>
      {% empty %}
      <li class="empty">Sin tratamientos</li>
      {% endfor %}
    </ul>
  </div>

  <div class="section">
    <h2>Prescripciones</h2>
    <table>
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Dosis</th>
          <th>Unidad</th>
          <th>Vía</th>
          <th>Frecuencia</th>
          <th>Duración</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prescriptions %}
        <tr>
          <td>{{ p.medication }}</td>
          <td class="num">{{ p.dosage }}</td>
          <td>{{ p.unit }}</td>
          <td>{{ p.route }}</td>
          <td>{{ p.frequency }}</td>
          <td>{{ p.duration }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="empty">Sin prescripciones</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Órdenes de Exámenes Médicos</h2>
    {% if tests %}
      <ul>
        {% for test in tests %}
        <li>
          {{ test.name }}
          {% if test.notes %} — {{ test.notes }}{% endif %}
          {% if test.status %} — Estado: {{ test.status }}{% endif %}
          {% if test.urgency %} — Urgencia: {{ test.urgency }}{% endif %}
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">No hay órdenes de exámenes en esta consulta.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Referencias Médicas</h2>
    {% if referrals %}
      <ul>
        {% for ref in referrals %}
        <li>
          {% if ref.specialties %}Especialidades: {{ ref.specialties|join:", " }} — {% endif %}
          {% if ref.referred_to %}Referido a: {{ ref.referred_to }} — {% endif %}
          {% if ref.notes %}{{ ref.notes }}{% else %}Sin notas{% endif %}
          {% if ref.status %} — Estado: {{ ref.status }}{% endif %}
          {% if ref.urgency %} — Urgencia: {{ ref.urgency }}{% endif %}
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">No hay referencias médicas en esta consulta.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Notas</h2>
    <p>{{ appointment.notes|default:"Sin notas" }}</p>
  </div>

  <footer>
    Este informe médico forma parte del expediente clínico institucional.<br>
    Emitido por {{ doctor.full_name }} - {{ institution.name }}<br>
    Código de auditoría: {{ report.id }}
    <div class="qr">
      <img src="{{ qr_code_url }}" alt="QR Auditoría" style="height:80px;">
    </div>
  </footer>
</body>
</html>
