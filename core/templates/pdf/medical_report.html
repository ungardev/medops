<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: "DejaVu Sans", sans-serif; font-size: 11pt; }
    header { text-align: center; border-bottom: 1px solid #000; margin-bottom: 15px; }
    h1 { font-size: 14pt; margin: 0; }
    h2 { font-size: 12pt; margin: 8px 0; }
    .section { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 10pt; }
    th, td { border: 1px solid #000; padding: 4px; text-align: left; }
    footer { margin-top: 20px; font-size: 9pt; text-align: center; border-top: 1px solid #000; }
    p { white-space: pre-wrap; margin: 4px 0; }
  </style>
</head>
<body>
  <header>
    {% if institution.logo %}
      <img src="{{ institution.logo.path }}" alt="Logo"
           style="max-width:120px; max-height:80px; object-fit:contain; margin-bottom:8px;">
    {% endif %}
    <h1>{{ institution.name }}</h1>
    <p>{{ institution.address }} - Tel: {{ institution.phone }} - RIF: {{ institution.tax_id }}</p>
    <p>Emitido el {{ generated_at|date:"d/m/Y H:i" }}</p>
  </header>

  <div class="section">
    <strong>Paciente:</strong> {{ patient.first_name }} {{ patient.last_name }}<br>
    C.I.: {{ patient.national_id }} - Edad: {{ patient.age }} - Sexo: {{ patient.gender }}
  </div>

  <div class="section">
    <strong>Médico:</strong> {{ doctor.full_name }}<br>
    Nº Colegiado: {{ doctor.colegiado_id }}<br>
    <p><strong>Especialidades:</strong>
      {% if doctor.specialties %}
        {% for s in doctor.specialties %}
          {{ s }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        No especificadas
      {% endif %}
    </p>
    {% if doctor.signature %}
      <div style="margin-top:8px;">
        <img src="{{ doctor.signature.path }}" alt="Firma" style="height:50px;">
      </div>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnósticos</h2>
    <table>
      <thead>
        <tr><th>Código</th><th>Nombre</th><th>Descripción</th></tr>
      </thead>
      <tbody>
        {% for d in diagnoses %}
        <tr>
          <td>{{ d.icd_code }}</td>
          <td>{{ d.title }}</td>
          <td>{{ d.description }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">Sin diagnósticos</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Tratamientos</h2>
    <ul>
      {% for t in treatments %}
      <li>{{ t.plan }}</li>
      {% empty %}
      <li>Sin tratamientos</li>
      {% endfor %}
    </ul>
  </div>

  <div class="section">
    <h2>Prescripciones</h2>
    <table>
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Dosis</th>
          <th>Unidad</th>
          <th>Vía</th>
          <th>Frecuencia</th>
          <th>Duración</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prescriptions %}
        <tr>
          <td>
            {% if p.medication_catalog %}
              {{ p.medication_catalog.name }} — {{ p.medication_catalog.presentation }} — {{ p.medication_catalog.concentration }}
            {% else %}
              {{ p.medication_text|default:"No especificado" }}
            {% endif %}
          </td>
          <td>{{ p.dosage|default:"-" }}</td>
          <td>{{ p.get_unit_display }}</td>
          <td>{{ p.get_route_display }}</td>
          <td>{{ p.get_frequency_display }}</td>
          <td>{{ p.duration|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6">Sin prescripciones</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Notas</h2>
    <p>{{ appointment.notes|default:"Sin notas" }}</p>
  </div>

  <footer>
    Este informe médico forma parte del expediente clínico institucional.<br>
    Emitido por {{ doctor.full_name }} - {{ institution.name }}<br>
    Código de auditoría: {{ report.id }}
  </footer>
</body>
</html>
