{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container" style="margin:20px;">
    <h1>{{ title }}</h1>

    <!-- üîπ Filtros -->
    <form method="get" class="form-inline" style="margin-bottom:20px;">
        <label for="start_date">Desde:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="vDateField" style="margin-right:10px;">

        <label for="end_date">Hasta:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="vDateField" style="margin-right:10px;">

        <button type="submit" class="button">Filtrar</button>
    </form>

    <!-- üîπ Botones de exportaci√≥n -->
    <div style="margin-bottom:20px;">
        <a href="{% url 'admin:payment-export-csv' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button" style="margin-right:10px;">
            ‚¨áÔ∏è Exportar CSV
        </a>
        <a href="{% url 'admin:payment-export-xlsx' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button" style="margin-right:10px;">
            üìë Exportar Excel
        </a>
        <a href="{% url 'admin:payment-export-pdf' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button">
            üñ®Ô∏è Exportar PDF
        </a>
    </div>

    <!-- üîπ M√©tricas globales -->
    <div style="margin-bottom:20px;">
        <h2>Totales Generales</h2>
        <ul>
            <li><strong>Total Recaudado:</strong> {{ total_revenue }}</li>
            <li><strong>N√∫mero de Pagos:</strong> {{ total_payments }}</li>
            <li><strong>Promedio por Pago:</strong> {{ avg_per_payment|floatformat:2 }}</li>
        </ul>
    </div>

    <!-- üîπ Totales por m√©todo -->
    <div style="margin-bottom:20px;">
        <h2>Totales por M√©todo</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>M√©todo</th>
                    <th>Cantidad</th>
                    <th>Monto Total</th>
                </tr>
            </thead>
            <tbody>
                {% for row in totals_by_method %}
                <tr>
                    <td>{{ row.method }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.total_amount }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3">No hay datos</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <canvas id="chartMethod" height="100"></canvas>
    </div>

    <!-- üîπ Totales por estado -->
    <div style="margin-bottom:20px;">
        <h2>Totales por Estado</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Estado</th>
                    <th>Cantidad</th>
                    <th>Monto Total</th>
                </tr>
            </thead>
            <tbody>
                {% for row in totals_by_status %}
                <tr>
                    <td>{{ row.status }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.total_amount }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3">No hay datos</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <canvas id="chartStatus" height="100"></canvas>
    </div>

    <!-- üîπ Bot√≥n volver -->
    <p>
        <a href="{% url 'admin:index' %}" class="button">‚¨ÖÔ∏è Volver al Admin</a>
    </p>
</div>

<!-- üîπ Datos JSON para JS -->
<script id="method-data" type="application/json">
    {{ totals_by_method_json|safe }}
</script>
<script id="status-data" type="application/json">
    {{ totals_by_status_json|safe }}
</script>

<!-- Chart.js y script externo -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'core/js/payment_report.js' %}"></script>
{% endblock %}
