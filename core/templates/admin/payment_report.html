{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container" style="margin:20px;">

    <h1>{{ title }}</h1>

    <!-- üîπ Filtros -->
    <form method="get" class="form-inline" style="margin-bottom:20px;">
        <label for="start_date">Desde:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="vDateField" style="margin-right:10px;">

        <label for="end_date">Hasta:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="vDateField" style="margin-right:10px;">

        <button type="submit" class="button">Filtrar</button>
    </form>

    <!-- üîπ Botones de exportaci√≥n -->
    <div style="margin-bottom:20px;">
        <a href="{% url 'admin:payment-export-csv' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button" style="margin-right:10px;">
            ‚¨áÔ∏è Exportar CSV
        </a>
        <a href="{% url 'admin:payment-export-xlsx' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button" style="margin-right:10px;">
            üìë Exportar Excel
        </a>
        <a href="{% url 'admin:payment-export-pdf' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="button">
            üñ®Ô∏è Exportar PDF
        </a>
    </div>

    <!-- üîπ Totales Generales -->
    <div class="totals-grid">
        <div class="card">üí∞ <strong>Total Recaudado:</strong><br>{{ total_revenue }}</div>
        <div class="card">üßæ <strong>N√∫mero de Pagos:</strong><br>{{ total_payments }}</div>
        <div class="card">üìä <strong>Promedio por Pago:</strong><br>{{ avg_per_payment|floatformat:2 }}</div>
    </div>

    <!-- üîπ Gr√°ficos en dos columnas -->
    <div class="charts-grid">
        <div class="chart-box">
            <h2>Totales por M√©todo</h2>
            <canvas id="chartMethod"></canvas>
            <table class="admin-table compact">
                <thead>
                    <tr><th>M√©todo</th><th>Cantidad</th><th>Monto Total</th></tr>
                </thead>
                <tbody>
                    {% for row in totals_by_method %}
                    <tr>
                        <td>{{ row.method }}</td>
                        <td>{{ row.count }}</td>
                        <td>{{ row.total_amount }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">No hay datos</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="chart-box">
            <h2>Totales por Estado</h2>
            <canvas id="chartStatus"></canvas>
            <table class="admin-table compact">
                <thead>
                    <tr><th>Estado</th><th>Cantidad</th><th>Monto Total</th></tr>
                </thead>
                <tbody>
                    {% for row in totals_by_status %}
                    <tr>
                        <td>{{ row.status }}</td>
                        <td>{{ row.count }}</td>
                        <td>{{ row.total_amount }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">No hay datos</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- üîπ Bot√≥n volver -->
    <p style="margin-top:20px;">
        <a href="{% url 'admin:index' %}" class="button">‚¨ÖÔ∏è Volver al Admin</a>
    </p>
</div>

<!-- üîπ Datos JSON para JS -->
<script id="method-data" type="application/json">
    {{ totals_by_method_json|safe }}
</script>
<script id="status-data" type="application/json">
    {{ totals_by_status_json|safe }}
</script>

<!-- Chart.js y script externo -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'core/js/payment_report.js' %}"></script>

<!-- üîπ CSS adaptado a light/dark mode -->
<style>
    .totals-grid {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .card {
        flex: 1;
        background: var(--body-bg);
        color: var(--body-fg);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        text-align: center;
        font-size: 14px;
    }
    .charts-grid {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    .chart-box {
        flex: 1;
        min-width: 350px;
        background: var(--body-bg);
        color: var(--body-fg);
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }
    canvas {
        max-width: 350px;
        max-height: 300px;
        margin: 0 auto 15px auto;
        display: block;
    }
    .admin-table.compact th,
    .admin-table.compact td {
        padding: 4px 8px;
        font-size: 13px;
        border: 1px solid var(--border-color);
        color: var(--body-fg);
    }
    .admin-table.compact th {
        background: var(--header-bg);
        color: var(--header-fg);
    }
</style>
{% endblock %}